name: Build grug.c

on: [push, pull_request]

jobs:
  regenerate:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    permissions:
      contents: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Concatenate files into grug.c
        run: |
          TMPBODY=$(mktemp)
          TMPFILE=$(mktemp)

          # Concatenate all sources into TMPBODY with an extra newline between each
          for f in src/01_grug_documentation.c \
                   src/02_includes_and_defines.c \
                   src/grug_backend.h \
                   src/03_utils.c \
                   src/04_runtime_error_handling.c \
                   src/05_json.c \
                   src/06_parsing_mod_api_json.c \
                   src/07_reading.c \
                   src/08_tokenization.c \
                   src/09_parsing.c \
                   src/10_dumping_ast.c \
                   src/11_applying_ast.c \
                   src/12_type_propagation.c \
                   src/13_grug_backend_linux.c \
                   src/14_hot_reloading.c \
                   src/LICENSE
          do
            # Strip `#include "2_includes_and_defines.c"` line if present
            # Delete the include line plus the next line (newline)
            sed '/^#include "[0-9][0-9]_.*\.c"$/{N;d}' "$f" >> "$TMPBODY"
            echo >> "$TMPBODY"  # extra newline between files
          done

          # Extract existing body of grug.c (skip include + timestamp)
          if [ -f grug.c ]; then
              EXISTING_BODY=$(sed '1,3d' grug.c)
          else
              EXISTING_BODY=""
          fi

          NEW_BODY=$(cat "$TMPBODY")

          # Compare and update only if source content differs
          if [ "$EXISTING_BODY" != "$NEW_BODY" ]; then
              echo "Source files changed; regenerating grug.c"

              echo "=== Diff of source content ==="
              diff <(echo "$EXISTING_BODY") <(echo "$NEW_BODY") || true

              {
                echo "// NOTE: DON'T EDIT THIS FILE! IT IS AUTOMATICALLY REGENERATED BASED ON THE FILES IN src/"
                echo "// Regenerated on $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
                echo
                cat "$TMPBODY"
              } > "$TMPFILE"
              mv "$TMPFILE" grug.c
          else
              echo "No content changes; grug.c unchanged"
          fi

      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git diff --quiet grug.c; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add grug.c
            git commit -m "chore: regenerate grug.c"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" HEAD:${{ github.ref }}
          fi
